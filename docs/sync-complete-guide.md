# 📚 东方财富研报抓取完全指南

> **最新版本 v2.0** | 最后更新: 2025-11-04
> 本文档是抓取功能的**完整参考手册**，涵盖日常抓取、自定义抓取和错误处理的所有场景。

---

## 📖 目录

- [快速开始](#快速开始)
- [三种抓取方式](#三种抓取方式)
  - [方式一：每日增量抓取](#方式一每日增量抓取-推荐)
  - [方式二：自定义日期抓取](#方式二自定义日期抓取)
  - [方式三：错误记录重试](#方式三错误记录重试)
- [配置说明](#配置说明)
- [文件与目录](#文件与目录)
- [常见场景](#常见场景)
- [故障排查](#故障排查)
- [性能优化](#性能优化)

---

## 🚀 快速开始

### 前置条件

1. ✅ 已安装 Bun 运行环境
2. ✅ 数据库连接已配置（`DATABASE_URL` 在 `.env` 中）
3. ✅ 已运行 `npm install` 安装依赖

### 最快 3 步运行

```bash
# 1. 进入后端目录
cd backend

# 2. 运行日常抓取（抓取最近 2 天数据）
npm run sync

# 3. 查看结果
# 控制台会显示详细统计信息
```

**预期耗时**: 约 3-5 分钟（取决于数据量）

---

## 三种抓取方式

### 方式一：每日增量抓取（推荐）⭐

**适用场景**：日常维护、定时任务、每日更新

#### 基本用法

```bash
cd backend
npm run sync
```

#### 工作原理

- 自动抓取最近 N 天的数据（默认 2 天）
- 自动去重（标题 + 日期 + 机构）
- 已存在的记录会更新，不存在则新增

#### 配置参数

通过环境变量控制抓取范围：

**临时设置（当次有效）:**
```bash
# Windows PowerShell
$env:SYNC_LOOKBACK_DAYS=7
npm run sync

# Git Bash / Linux / macOS
export SYNC_LOOKBACK_DAYS=7
npm run sync
```

**永久设置（修改 .env）:**
```env
# backend/.env 或根目录 .env
SYNC_LOOKBACK_DAYS=2        # 抓取最近 2 天
SYNC_CONCURRENCY=8          # 并发数 8（默认）
```

#### 输出示例

```
╔════════════════════════════════════════════════════════════╗
║        🌐 东方财富研报聚合 - 增量数据同步                   ║
╚════════════════════════════════════════════════════════════╝

⚙️  配置: 最近 2 天 | 并发数: 8
📊 分类: 策略研报 → 宏观研报 → 行业研报 → 个股研报

▶︎ 进度: 1/4 - 正在处理【策略研报】...
   ✓ 获取 45 条 | 新增 3 条 | 更新 42 条 | 错误 0 条

... (其他分类)

╔════════════════════════════════════════════════════════════╗
║                     ✓ 同步完成                              ║
╚════════════════════════════════════════════════════════════╝

📊 汇总统计（耗时 180s）:
   • 总获取: 486 条
   • 新增:   12 条 ✓
   • 更新:   467 条 ✓
   • 错误:   7 条
```

#### 使用场景

| 场景 | LOOKBACK_DAYS | 说明 |
|------|---------------|------|
| 日常更新 | 2 | 每天运行一次，抓取最新数据 |
| 周末补数据 | 3-4 | 周末运行，补充周五到周日的数据 |
| 补历史数据 | 7-30 | 一次性补充最近一段时间的数据 |
| 测试验证 | 1 | 只抓今天，快速验证功能 |

---

### 方式二：自定义日期抓取

**适用场景**：补充历史数据、指定日期范围抓取

#### 基本用法

```bash
cd backend
npm run sync:date <开始日期> <结束日期>
```

#### 日期格式

- 必须使用 `YYYY-MM-DD` 格式
- 开始日期不能晚于结束日期
- 支持单日抓取（开始 = 结束）

#### 使用示例

**示例 1: 抓取单日数据**
```bash
npm run sync:date 2025-01-01 2025-01-01
```

**示例 2: 抓取日期范围**
```bash
npm run sync:date 2025-01-01 2025-01-31
```

**示例 3: 抓取最近一周**
```bash
npm run sync:date 2025-10-28 2025-11-04
```

**示例 4: 补充历史数据（大范围）**
```bash
# 设置较低并发避免超时
$env:SYNC_CONCURRENCY=2
npm run sync:date 2024-01-01 2024-12-31
```

#### 抓取流程

1. **数据获取** - 从东方财富 API 获取指定范围的研报列表
2. **去重检查** - 批量查询数据库中已存在的记录
3. **详情抓取** - 并发抓取每条研报的详情页内容
4. **数据入库** - 新增或更新数据库记录
5. **错误记录** - 失败的记录保存到 `error-logs/` 文件夹

#### 配置并发数

```bash
# 小范围、网络好 - 使用较高并发（快）
$env:SYNC_CONCURRENCY=4
npm run sync:date 2025-01-01 2025-01-07

# 大范围、网络不稳定 - 使用较低并发（稳）
$env:SYNC_CONCURRENCY=1
npm run sync:date 2024-01-01 2024-12-31
```

#### 输出文件

**成功时：**
- 数据保存到数据库
- 控制台显示统计信息

**有错误时：**
- 错误日志保存到: `error-logs/sync-errors-<开始日期>-to-<结束日期>-<当前日期>.json`
- 例如: `error-logs/sync-errors-2025-01-01-to-2025-01-31-2025-11-04.json`

#### 超时与重试

- **每条记录超时**: 60 秒
- **超时后**: 自动跳过并记录到错误日志
- **后续处理**: 使用[错误记录重试](#方式三错误记录重试)功能重新抓取

#### 注意事项

⚠️ **大范围抓取建议：**
1. 分段抓取（如按月份：1月、2月、3月...）
2. 降低并发数（1-2）
3. 避开高峰时段
4. 准备好重试错误记录

---

### 方式三：错误记录重试

**适用场景**：重新抓取之前失败的记录

#### 基本用法

```bash
cd backend
npm run sync:retry <错误日志文件名>
```

#### 文件名格式

错误日志存放在 `error-logs/` 文件夹，可以：

**直接使用文件名（推荐）:**
```bash
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-04.json
```

**使用相对路径:**
```bash
npm run sync:retry ../error-logs/sync-errors-2025-01-01-to-2025-01-31-2025-11-04.json
```

**使用绝对路径:**
```bash
npm run sync:retry "C:\完整路径\error-logs\sync-errors-2025-01-01-to-2025-01-31-2025-11-04.json"
```

#### 查看所有错误日志

```bash
# 在项目根目录
ls error-logs/

# 或在 backend 目录
ls ../error-logs/
```

#### 使用示例

**示例 1: 重试最近的错误**
```bash
# 查看有哪些错误日志
ls ../error-logs/

# 重试指定的错误日志
npm run sync:retry sync-errors-2025-01-01-to-2025-01-10-2025-11-03.json
```

**示例 2: 重试之前重试生成的日志**
```bash
# 第一次重试后可能生成带 -retry- 后缀的新日志
npm run sync:retry sync-errors-2025-01-01-to-2025-01-10-2025-11-03-retry-2025-11-04.json
```

**示例 3: 降低并发重试（提高稳定性）**
```bash
$env:SYNC_CONCURRENCY=1
npm run sync:retry sync-errors-2025-03-01-to-2025-03-31-2025-11-03.json
```

#### 重试流程

1. **读取错误日志** - 从 JSON 文件加载所有失败记录
2. **显示统计信息** - 展示失败总数和分类分布
3. **按分类重试** - 逐个分类重新抓取失败记录
4. **实时显示进度** - 每条记录显示成功/失败状态
5. **生成新日志** - 仍然失败的记录保存到新的错误日志

#### 输出示例

```
╔════════════════════════════════════════════════════════════╗
║              🔄 重新抓取失败记录                            ║
╚════════════════════════════════════════════════════════════╝

📋 错误日志摘要:
   • 总失败条数: 7 条
   • 生成时间: 2025-11-03T07:16:46.418Z
   • 【宏观研报】: 1 条
   • 【行业研报】: 6 条

⚙️  重试配置:
   • 并发数: 1
   • 超时时间: 90秒

🔄 开始重新抓取...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【宏观研报】共 1 条记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✓ 成功: 中国税务快讯：关于《在中国境内就业的外国人...

【宏观研报】完成: 成功 1 条, 失败 0 条

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【行业研报】共 6 条记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✓ 成功: 2024中国人工智能岗位招聘研究报告
  ✓ 成功: 机械一周解一惑系列：AI驱动美国燃气轮机...
  ✗ 失败: 公用环保2025年1月投资策略：2024年全国...
    错误: 记录处理超时 (90000ms)
  ✓ 成功: 化工行业周报：国际油价上涨，丙烯酸价格...
  ✓ 成功: 传媒互联网产业行业研究：OpenAI发布新年...
  ✓ 成功: 传媒行业周报：关注CES、微信小店"送礼物"...

【行业研报】完成: 成功 5 条, 失败 1 条

╔════════════════════════════════════════════════════════════╗
║                     ✓ 重试完成                             ║
╚════════════════════════════════════════════════════════════╝

📊 重试统计 (耗时 85秒):
   • 总记录数: 7 条
   • 成功:     6 条 ✓
   • 失败:     1 条
   • 成功率:   85.7%

📋 分类统计:
   【宏观研报】成功: 1 | 失败: 0 | 成功率: 100.0%
   【行业研报】成功: 5 | 失败: 1 | 成功率: 83.3%

⚠️  仍有 1 条记录失败
✓ 新错误日志已保存到: error-logs/sync-errors-...-retry-2025-11-04.json
```

#### 多次重试策略

**策略 1: 等待后重试**
```bash
# 等待 5-10 分钟（网络可能暂时不稳定）
# 然后重试新生成的日志
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-retry-2025-11-04.json
```

**策略 2: 降低并发重试**
```bash
# 设置并发数为 1（最稳定）
$env:SYNC_CONCURRENCY=1
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-04.json
```

**策略 3: 分析错误原因**
- 打开错误日志 JSON 文件
- 查看 `error` 字段了解失败原因
- 如果是超时，可以等待后重试
- 如果是网络错误，检查网络连接
- 如果是持续失败，可能是目标页面问题

#### 超时与配置

- **每条记录超时**: 90 秒（比正常抓取的 60 秒更宽松）
- **默认并发数**: 1（优先稳定性）
- **推荐并发数**: 1-2

#### 输出文件

**全部成功：**
- 无新文件生成
- 显示 "🎉 所有记录都已成功重试!"

**仍有失败：**
- 新错误日志: `<原文件名>-retry-<日期>.json`
- 保存位置: `error-logs/` 文件夹

---

## ⚙️ 配置说明

### 环境变量配置

所有抓取脚本支持以下环境变量：

| 变量名 | 默认值 | 说明 | 适用脚本 |
|--------|--------|------|----------|
| `SYNC_LOOKBACK_DAYS` | 2 | 每日抓取的回溯天数 | 每日增量抓取 |
| `SYNC_CONCURRENCY` | 见下表 | 并发抓取数量 | 所有脚本 |
| `DATABASE_URL` | - | 数据库连接字符串 | 所有脚本（必需） |

### 并发数默认值

| 脚本 | 默认并发数 | 推荐范围 | 说明 |
|------|-----------|---------|------|
| 每日增量抓取 (`sync`) | 8 | 4-12 | 速度优先，适合小范围 |
| 自定义日期抓取 (`sync:date`) | 2 | 1-4 | 平衡速度和稳定性 |
| 错误记录重试 (`sync:retry`) | 1 | 1-2 | 稳定性优先 |

### 并发数选择建议

| 并发数 | 速度 | 稳定性 | 适用场景 |
|--------|------|--------|----------|
| 1 | 慢 | 极高 ⭐⭐⭐ | 大范围抓取、错误重试、网络不稳定 |
| 2 | 适中 | 高 ⭐⭐ | **自定义日期抓取推荐** |
| 4-6 | 快 | 中 ⭐ | 小范围抓取、网络良好 |
| 8+ | 很快 | 低 | 仅限每日增量、测试环境 |

### 配置方式

#### 方式 1: 修改 .env 文件（永久生效）

编辑 `backend/.env` 或根目录 `.env`：

```env
# 数据库连接（必需）
DATABASE_URL="postgresql://..."

# 抓取配置
SYNC_LOOKBACK_DAYS=2        # 每日抓取回溯天数
SYNC_CONCURRENCY=2          # 默认并发数
```

#### 方式 2: 临时环境变量（当次有效）

**Windows PowerShell:**
```powershell
$env:SYNC_CONCURRENCY=4
npm run sync:date 2025-01-01 2025-01-01
```

**Git Bash / Linux / macOS:**
```bash
export SYNC_CONCURRENCY=4
npm run sync:date 2025-01-01 2025-01-01

# 或在同一行
SYNC_CONCURRENCY=4 npm run sync:date 2025-01-01 2025-01-01
```

#### 方式 3: 修改脚本默认值（全局永久）

找到对应脚本文件中的这一行并修改：

**每日增量抓取:**
```typescript
// backend/scripts/sync-runner.ts 第 9 行
const CONCURRENCY = Number(process.env.SYNC_CONCURRENCY ?? "8");
//                                                          ↑ 改这里
```

**自定义日期抓取:**
```typescript
// backend/scripts/sync-custom-range.ts 第 20 行
const CONCURRENCY = Number(process.env.SYNC_CONCURRENCY ?? "2");
//                                                          ↑ 改这里
```

**错误记录重试:**
```typescript
// backend/scripts/sync-retry-errors.ts 第 58 行
const CONCURRENCY = Number(process.env.SYNC_CONCURRENCY ?? "1");
//                                                          ↑ 改这里
```

---

## 📂 文件与目录

### 项目结构

```
investment-research-report/
├── backend/
│   ├── scripts/
│   │   ├── sync-runner.ts           # 每日增量抓取脚本
│   │   ├── sync-custom-range.ts     # 自定义日期抓取脚本
│   │   ├── sync-retry-errors.ts     # 错误记录重试脚本
│   │   ├── fetch-list.ts            # 列表页抓取（含重试逻辑）
│   │   ├── detail-parser.ts         # 详情页解析
│   │   └── category-config.ts       # 分类配置
│   ├── lib/
│   │   └── prisma.ts                # 数据库连接（含重试机制）
│   ├── .env                         # 后端配置文件
│   └── package.json                 # 包含抓取命令定义
├── error-logs/                      # 错误日志存放文件夹
│   ├── .gitkeep                     # 保持文件夹结构
│   ├── sync-errors-2025-01-01-to-2025-01-10-2025-11-03.json
│   └── sync-errors-...-retry-2025-11-04.json
├── prisma/
│   └── schema.prisma                # 数据库模型定义
├── docs/
│   └── sync-complete-guide.md       # 本文档
├── .env                             # 全局配置文件
└── .gitignore                       # 包含错误日志忽略规则
```

### 重要文件说明

**配置文件:**
- `.env` - 环境变量配置（数据库连接、抓取参数）
- `prisma/schema.prisma` - 数据库模型（Report 表定义）

**抓取脚本:**
- `sync-runner.ts` - 每日增量抓取（最近 N 天）
- `sync-custom-range.ts` - 自定义日期范围抓取
- `sync-retry-errors.ts` - 错误记录重试

**辅助模块:**
- `fetch-list.ts` - 列表页数据获取（JSONP 解析、重试机制）
- `detail-parser.ts` - 详情页解析（摘要、PDF、标签提取）
- `category-config.ts` - 四类研报的 API 配置

**错误日志:**
- `error-logs/` - 所有错误日志存放位置
- 文件名格式: `sync-errors-<开始>-to-<结束>-<日期>.json`
- 重试后文件: `sync-errors-<开始>-to-<结束>-<日期>-retry-<日期>.json`

---

## 🎯 常见场景

### 场景 1: 每天定时抓取最新数据

**需求**: 每天自动抓取最新发布的研报

**方案**:
```bash
# 配置 .env
SYNC_LOOKBACK_DAYS=2
SYNC_CONCURRENCY=8

# 每天运行
cd backend
npm run sync
```

**自动化**: 使用 GitHub Actions 或 cron job 定时运行

---

### 场景 2: 补充最近一个月的历史数据

**需求**: 一次性补充最近 30 天的所有研报

**方案 A - 使用每日抓取（推荐）:**
```bash
# 临时设置抓取天数
$env:SYNC_LOOKBACK_DAYS=30
npm run sync
```

**方案 B - 使用自定义日期:**
```bash
# 指定具体日期范围
npm run sync:date 2025-10-01 2025-10-31
```

**建议**: 如果出现错误，使用重试功能处理

---

### 场景 3: 补充 2024 年全年数据

**需求**: 抓取 2024 年 1 月 1 日到 12 月 31 日的所有数据

**方案**: 分月抓取（避免超时）

```bash
# 降低并发数
$env:SYNC_CONCURRENCY=2

# 分月抓取
npm run sync:date 2024-01-01 2024-01-31  # 1月
npm run sync:date 2024-02-01 2024-02-29  # 2月
npm run sync:date 2024-03-01 2024-03-31  # 3月
# ... 依此类推

# 如果有错误日志，批量重试
npm run sync:retry sync-errors-2024-01-01-to-2024-01-31-2025-11-04.json
npm run sync:retry sync-errors-2024-02-01-to-2024-02-29-2025-11-04.json
# ...
```

---

### 场景 4: 处理网络不稳定环境

**需求**: 在网络不稳定的环境下抓取数据

**方案**:
```bash
# 1. 降低并发数到最低
$env:SYNC_CONCURRENCY=1

# 2. 分段抓取（减小范围）
npm run sync:date 2025-01-01 2025-01-07
npm run sync:date 2025-01-08 2025-01-14
# ...

# 3. 错误记录多次重试
npm run sync:retry sync-errors-2025-01-01-to-2025-01-07-2025-11-04.json
# 等待 10 分钟后再次重试
npm run sync:retry sync-errors-2025-01-01-to-2025-01-07-retry-2025-11-04.json
```

---

### 场景 5: 快速验证功能

**需求**: 快速测试抓取功能是否正常

**方案**:
```bash
# 只抓取今天的数据
npm run sync:date 2025-11-04 2025-11-04

# 预期: 1-2 分钟完成
```

---

### 场景 6: 处理大量错误记录

**需求**: 重试多个错误日志文件

**方案**:
```bash
# 1. 查看所有错误日志
ls ../error-logs/

# 2. 依次重试（使用脚本）
# 创建批处理脚本 retry-all.ps1:
Get-ChildItem ../error-logs -Filter "sync-errors-*.json" | ForEach-Object {
    Write-Host "重试: $($_.Name)"
    npm run sync:retry $_.Name
}

# 3. 运行批处理脚本
powershell ./retry-all.ps1
```

---

## 🐛 故障排查

### 问题 1: 抓取时出现大量超时

**现象**: 控制台显示多条 "记录处理超时 (60000ms)"

**原因**:
- 并发数过高
- 网络不稳定
- 目标服务器限流

**解决方法**:
```bash
# 1. 降低并发数
$env:SYNC_CONCURRENCY=1
npm run sync

# 2. 如果仍超时，分段抓取
npm run sync:date 2025-01-01 2025-01-07  # 缩小范围
```

---

### 问题 2: 数据库连接失败

**现象**:
```
Error: P1001: Can't reach database server
```

**原因**:
- DATABASE_URL 配置错误
- 数据库服务未运行
- 网络问题

**解决方法**:
```bash
# 1. 检查 .env 文件中的 DATABASE_URL
cat .env | grep DATABASE_URL

# 2. 测试数据库连接
bunx prisma db pull --schema ../prisma/schema.prisma

# 3. 确认数据库服务运行中（Neon 需要确保未暂停）
```

---

### 问题 3: 错误日志文件找不到

**现象**:
```
ENOENT: no such file or directory
```

**原因**: 文件路径错误或文件不存在

**解决方法**:
```bash
# 1. 查看所有错误日志
ls ../error-logs/

# 2. 直接使用文件名（脚本会自动查找）
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-04.json

# 3. 如果找不到，使用绝对路径
npm run sync:retry "C:\完整路径\error-logs\文件名.json"
```

---

### 问题 4: 抓取到重复数据

**现象**: 数据库中出现重复的研报记录

**原因**:
- 去重逻辑失效（标题/日期/机构 不一致）
- 并发冲突

**解决方法**:
```sql
-- 1. 查找重复记录
SELECT title, date, org, COUNT(*) as count
FROM "Report"
GROUP BY title, date, org
HAVING COUNT(*) > 1;

-- 2. 删除重复记录（保留最新的）
-- 谨慎操作，建议备份后执行
```

---

### 问题 5: 环境变量未生效

**现象**: 修改了 SYNC_CONCURRENCY 但并发数没变

**原因**:
- PowerShell 环境变量作用域
- .env 文件未保存

**解决方法**:
```powershell
# 1. 确认环境变量已设置
echo $env:SYNC_CONCURRENCY

# 2. 在同一个 PowerShell 窗口运行
$env:SYNC_CONCURRENCY=4
npm run sync

# 3. 或者直接修改 .env 文件
# 编辑 backend/.env
SYNC_CONCURRENCY=4
```

---

### 问题 6: 脚本运行卡住不动

**现象**: 脚本运行一段时间后无任何输出

**可能原因**:
- 某条记录处理超时
- 数据库连接断开
- 网络中断

**解决方法**:
```bash
# 1. 按 Ctrl+C 强制停止

# 2. 查看最后的输出，确定卡在哪个分类

# 3. 重新运行，如果仍卡住，查看错误日志
cat error-logs/最新的错误日志.json

# 4. 检查网络连接
ping data.eastmoney.com
```

---

### 问题 7: 脚本报错 "找不到模块"

**现象**:
```
Error: Cannot find module 'xxx'
```

**原因**: 依赖未安装或 node_modules 损坏

**解决方法**:
```bash
# 1. 重新安装依赖
cd backend
npm install

# 2. 生成 Prisma 客户端
npm run prisma:generate

# 3. 重新运行脚本
npm run sync
```

---

## ⚡ 性能优化

### 优化历史

| 项目 | 优化前 | 优化后 | 提升 |
|------|-------|-------|------|
| 并发数 | 1 | 2-8 | +100%~700% |
| 数据库查询 | 每条 1 次 | 批量 1 次 | -99% |
| 详情页抓取 | 串行 | 并行 | -50% |
| 总耗时（2天数据） | ~7 分钟 | ~3 分钟 | -57% |
| 成功率 | ~95% | ~98.8% | +3.8% |

### 性能建议

#### 1. 合理设置并发数

**小范围抓取（1-7天）:**
```env
SYNC_CONCURRENCY=4
```

**中等范围（7-30天）:**
```env
SYNC_CONCURRENCY=2
```

**大范围（30天以上）:**
```env
SYNC_CONCURRENCY=1
```

#### 2. 使用批量查询

脚本已自动实现批量去重查询，无需手动优化。

#### 3. 分段抓取大范围数据

```bash
# 不推荐：一次抓取全年
npm run sync:date 2024-01-01 2024-12-31  # 可能超时

# 推荐：分月抓取
npm run sync:date 2024-01-01 2024-01-31
npm run sync:date 2024-02-01 2024-02-29
# ...
```

#### 4. 避开高峰时段

- **推荐时段**: 凌晨 1:00 - 6:00（服务器负载低）
- **避开时段**: 9:00 - 17:00（交易时间）

#### 5. 监控错误率

```bash
# 运行后检查错误率
# 总错误 / 总抓取 < 5% → 正常
# 总错误 / 总抓取 > 10% → 需要优化（降低并发）
```

---

## 📊 数据统计

### 已验证的数据量

- **总测试记录**: 3,000+ 条
- **日期范围**: 2025-01-01 至 2025-03-31
- **平均成功率**: 98.8%
- **平均错误率**: 1.2%（主要是超时）

### 各分类数据量（2天数据示例）

| 分类 | 平均条数 | 占比 |
|------|---------|------|
| 策略研报 | 45 | 9% |
| 宏观研报 | 89 | 18% |
| 行业研报 | 298 | 62% |
| 个股研报 | 54 | 11% |
| **合计** | **486** | **100%** |

---

## 📞 获取帮助

### 相关文档

- **抓取机制详解**: `docs/sync-mechanism.md`
- **优化记录**: `docs/optimization-done.md`
- **GitHub Actions 自动化**: `docs/github-actions-setup.md`
- **本地开发指南**: `docs/local-dev.md`

### 代码注释

所有抓取脚本都有详细的中文注释：
- `backend/scripts/sync-runner.ts`
- `backend/scripts/sync-custom-range.ts`
- `backend/scripts/sync-retry-errors.ts`

### 问题反馈

如遇到本文档未涵盖的问题：
1. 查看控制台完整错误信息
2. 检查 `error-logs/` 中的错误日志
3. 查看数据库连接状态
4. 提交 Issue 并附上错误日志

---

## 📝 快速命令参考

```bash
# ============ 每日增量抓取 ============
cd backend
npm run sync                              # 抓取最近 2 天（默认）
$env:SYNC_LOOKBACK_DAYS=7; npm run sync   # 临时设置抓取 7 天

# ============ 自定义日期抓取 ============
npm run sync:date 2025-01-01 2025-01-01   # 抓取单日
npm run sync:date 2025-01-01 2025-01-31   # 抓取日期范围
$env:SYNC_CONCURRENCY=1                   # 降低并发
npm run sync:date 2024-01-01 2024-12-31   # 抓取大范围

# ============ 错误记录重试 ============
ls ../error-logs/                         # 查看错误日志
npm run sync:retry <文件名>                # 重试错误记录
$env:SYNC_CONCURRENCY=1                   # 降低并发提高稳定性

# ============ 其他有用命令 ============
cat ../.env | grep SYNC                   # 查看当前配置
bunx prisma studio                        # 打开数据库管理界面
```

---

## 🔖 版本历史

**v2.0 (2025-11-04)**
- ✨ 错误日志统一存放到 `error-logs/` 文件夹
- ✨ 错误重试脚本支持智能路径查找
- ✨ 新增详细的使用场景和故障排查
- ✨ 整合所有抓取方式的完整文档

**v1.0 (2025-11-03)**
- 初始版本：每日抓取、自定义抓取、错误重试

---

**最后更新**: 2025-11-04
**文档版本**: v2.0
**维护状态**: ✅ 活跃维护中
