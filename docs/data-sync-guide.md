# 📚 东方财富研报数据抓取完整指南

本文档提供东方财富研报聚合系统的数据抓取完整操作指南，包括正常抓取和错误重试两种场景。

---

## 📖 目录

1. [正常手动抓取](#正常手动抓取)
2. [错误日志重新抓取](#错误日志重新抓取)
3. [配置说明](#配置说明)
4. [常见问题](#常见问题)

---

## 🚀 正常手动抓取

### 功能说明

用于指定日期范围抓取东方财富研报数据，支持单日或多日范围。

### 使用方式

#### 基本命令

```bash
cd backend
npm run sync:date <开始日期> <结束日期>
```

#### 使用示例

**示例 1: 抓取单日数据**
```bash
npm run sync:date 2025-01-01 2025-01-01
```

**示例 2: 抓取日期范围数据**
```bash
npm run sync:date 2025-01-01 2025-01-31
```

**示例 3: 抓取最近一周数据**
```bash
npm run sync:date 2025-01-01 2025-01-07
```

### 抓取流程

1. **数据获取** - 从东方财富 API 获取指定日期范围的研报列表
2. **分类处理** - 按顺序处理四类研报（策略 → 宏观 → 行业 → 个股）
3. **详情抓取** - 并发抓取每条研报的详情页（摘要、PDF、标签等）
4. **数据入库** - 自动去重并保存到数据库（新增或更新）
5. **错误记录** - 失败的记录自动保存到错误日志文件

### 输出文件

**成功时：**
- 数据直接保存到数据库
- 控制台显示详细统计信息

**有错误时：**
- 生成错误日志文件: `sync-errors-<开始日期>-to-<结束日期>-<当前日期>.json`
- 例如: `sync-errors-2025-01-01-to-2025-01-31-2025-11-03.json`
- 文件位置: **`error-logs/` 文件夹**

### 命令输出示例

```
╔════════════════════════════════════════════════════════════╗
║     🌐 东方财富研报聚合 - 自定义日期范围数据同步           ║
╚════════════════════════════════════════════════════════════╝

📅 日期范围: 2025-01-01 至 2025-01-01
⚙️  并发数: 2
📊 分类: 策略研报 → 宏观研报 → 行业研报 → 个股研报

▶︎ 进度: 1/4 - 正在处理【策略研报】...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【策略研报】开始处理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[1/4] 从 API 查询 2025-01-01 至 2025-01-01 的数据...
      ✓ 获取 45 条数据
[2/4] 检查数据库中的已存在记录用于去重...
      ✓ 数据库中已存在 42 条记录
      → 待处理: 3 条新数据 + 42 条待更新
[3/4] 抓取详情页并入库（并发数: 2）...
      ⟳ 已处理 45/45 条...
      ✓ 详情页抓取完成 (成功: 44, 失败: 1)
[4/4] 汇总统计
      ✓ 新增: 3 条
      ✓ 更新: 41 条
      ✓ 错误: 1 条

【策略研报】处理完成 ✓

...（其他分类类似）

╔════════════════════════════════════════════════════════════╗
║                       ✓ 同步完成                            ║
╚════════════════════════════════════════════════════════════╝

📊 汇总统计（耗时 180s）:
   • 总获取条数: 486 条
   • 新增条数:   12 条 ✓
   • 更新条数:   467 条 ✓
   • 错误条数:   7 条

📋 分类统计:
   【策略研报】获取: 45 | 新增: 3 | 更新: 41 | 错误: 1
   【宏观研报】获取: 89 | 新增: 2 | 更新: 86 | 错误: 1
   【行业研报】获取: 298 | 新增: 5 | 更新: 287 | 错误: 6
   【个股研报】获取: 54 | 新增: 2 | 更新: 53 | 错误: 0

✓ 错误日志已保存到: C:\...\error-logs\sync-errors-2025-01-01-to-2025-01-01-2025-11-03.json
```

### 注意事项

1. **日期格式**: 必须使用 `YYYY-MM-DD` 格式（例如: `2025-01-01`）
2. **开始结束顺序**: 开始日期不能晚于结束日期
3. **执行时间**: 根据数据量和并发设置，抓取时间从几分钟到几十分钟不等
4. **超时处理**: 每条记录设置 60 秒超时，超时记录会自动跳过并记录到错误日志
5. **自动去重**: 根据 `(标题 + 日期 + 机构)` 三元组去重，已存在则更新

---

## 🔄 错误日志重新抓取

### 功能说明

用于重新抓取之前失败的记录，读取错误日志文件并重试所有失败的记录。

### 适用场景

- ✅ 初次抓取时出现超时错误
- ✅ 网络临时故障导致部分记录失败
- ✅ 数据库连接问题导致入库失败
- ✅ 任何需要重新尝试失败记录的情况

### 使用方式

#### 基本命令

```bash
cd backend
npm run sync:retry <错误日志文件名>
```

#### 使用示例

**示例 1: 直接使用文件名（推荐）⭐**
```bash
# 脚本会自动在 error-logs 文件夹中查找
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-03.json
```

**示例 2: 重试之前重试生成的日志**
```bash
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-03-retry-2025-11-03.json
```

**示例 3: 使用相对路径**
```bash
npm run sync:retry ../error-logs/sync-errors-2025-03-01-to-2025-03-31-2025-11-03.json
```

### 重试流程

1. **读取错误日志** - 从 JSON 文件读取所有失败记录
2. **显示统计摘要** - 展示总数和分类分布
3. **按分类重试** - 逐个分类重新抓取失败的记录
4. **实时显示进度** - 每条记录显示成功或失败状态
5. **生成新错误日志** - 如果仍有失败，保存到新的日志文件

### 输出文件

**全部成功时：**
- 无新文件生成
- 控制台显示 "🎉 所有记录都已成功重试!"

**仍有失败时：**
- 生成新错误日志: `<原文件名>-retry-<当前日期>.json`
- 例如: `sync-errors-2025-01-01-to-2025-01-31-2025-11-03-retry-2025-11-03.json`
- 文件位置: **`error-logs/` 文件夹**

### 命令输出示例

```
╔════════════════════════════════════════════════════════════╗
║              🔄 重新抓取失败记录                            ║
╚════════════════════════════════════════════════════════════╝

📋 错误日志摘要:
   • 总失败条数: 7 条
   • 生成时间: 2025-11-03T07:16:46.418Z
   • 【宏观研报】: 1 条
   • 【行业研报】: 6 条

⚙️  重试配置:
   • 并发数: 1
   • 超时时间: 90秒

🔄 开始重新抓取...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【宏观研报】共 1 条记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✓ 成功: 中国税务快讯：关于《在中国境内就业的外国人参加社会保险...

【宏观研报】完成: 成功 1 条, 失败 0 条

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【行业研报】共 6 条记录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✓ 成功: 2024中国人工智能岗位招聘研究报告
  ✓ 成功: 机械一周解一惑系列：AI驱动美国燃气轮机景气度上行
  ✗ 失败: 公用环保2025年1月投资策略：2024年全国碳市场配额交易...
    错误: 记录处理超时 (90000ms)
  ✓ 成功: 化工行业周报：国际油价上涨，丙烯酸价格上涨、尿素价格下跌
  ✓ 成功: 传媒互联网产业行业研究：OpenAI发布新年目标，关注有基本...
  ✗ 失败: 传媒行业周报：关注CES、微信小店"送礼物"更新及线下文娱消费
    错误: 网络请求失败: ECONNRESET

【行业研报】完成: 成功 4 条, 失败 2 条

╔════════════════════════════════════════════════════════════╗
║                     ✓ 重试完成                             ║
╚════════════════════════════════════════════════════════════╝

📊 重试统计 (耗时 85秒):
   • 总记录数: 7 条
   • 成功:     5 条 ✓
   • 失败:     2 条
   • 成功率:   71.4%

📋 分类统计:
   【宏观研报】成功: 1 | 失败: 0 | 成功率: 100.0%
   【行业研报】成功: 4 | 失败: 2 | 成功率: 66.7%

⚠️  仍有 2 条记录失败
✓ 新错误日志已保存到: sync-errors-2025-01-01-to-2025-01-31-2025-11-03-retry-2025-11-03.json
```

### 多次重试策略

如果第一次重试后仍有失败记录：

**方法 1: 等待后再次重试**
```bash
# 等待 5-10 分钟（网络可能暂时不稳定）
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-03-retry-2025-11-03.json
```

**方法 2: 调整并发数重试**
```bash
# 设置并发数为 1（更稳定）
export SYNC_CONCURRENCY=1
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-03.json
```

**方法 3: 检查原因后手动处理**
- 查看错误日志中的 `error` 字段
- 如果是持续超时，可能是目标网站限制
- 如果是网络错误，检查网络连接

### 注意事项

1. **错误日志位置**: 错误日志文件通常在项目根目录
2. **超时时间**: 重试时超时时间为 90 秒（比正常抓取的 60 秒更宽松）
3. **并发控制**: 默认并发数为 1，优先保证稳定性
4. **自动保存**: 重试仍失败的记录会自动保存到新的错误日志
5. **可重复执行**: 可以对同一个错误日志多次重试，直到全部成功

---

## ⚙️ 配置说明

### 并发数配置 (SYNC_CONCURRENCY)

并发数控制同时抓取详情页的任务数量，影响抓取速度和稳定性。

#### 默认值位置

**正常抓取（sync-custom-range.ts）:**
```typescript
// backend/scripts/sync-custom-range.ts
// 第 20 行
const CONCURRENCY = Number(process.env.SYNC_CONCURRENCY ?? "2");
```
- **默认值**: `2`
- **推荐值**: `1-4`

**错误重试（sync-retry-errors.ts）:**
```typescript
// backend/scripts/sync-retry-errors.ts
// 第 58 行
const CONCURRENCY = Number(process.env.SYNC_CONCURRENCY ?? "1");
```
- **默认值**: `1`
- **推荐值**: `1-2`

#### 修改方式

**方式 1: 修改脚本文件（永久修改）**

编辑对应脚本文件，将默认值改为你想要的数字：

```typescript
// 将默认值从 2 改为 4
const CONCURRENCY = Number(process.env.SYNC_CONCURRENCY ?? "4");
```

**方式 2: 使用环境变量（临时修改）**

在命令前设置环境变量：

```bash
# Windows CMD
set SYNC_CONCURRENCY=4
npm run sync:date 2025-01-01 2025-01-01

# Windows PowerShell
$env:SYNC_CONCURRENCY=4
npm run sync:date 2025-01-01 2025-01-01

# Linux / macOS / Git Bash
export SYNC_CONCURRENCY=4
npm run sync:date 2025-01-01 2025-01-01

# 或者在同一行
SYNC_CONCURRENCY=4 npm run sync:date 2025-01-01 2025-01-01
```

**方式 3: 在 .env 文件中配置（全局修改）**

编辑 `backend/.env` 文件，添加：

```env
SYNC_CONCURRENCY=4
```

#### 并发数选择建议

| 并发数 | 速度 | 稳定性 | 适用场景 |
|--------|------|--------|----------|
| 1 | 慢 | 极高 | 网络不稳定、错误重试 |
| 2 | 适中 | 高 | **正常抓取推荐** ⭐ |
| 3-4 | 快 | 中 | 网络良好、大批量抓取 |
| 5+ | 很快 | 低 | ⚠️ 不推荐（易超时/被限制） |

**注意事项：**
- 并发数过高可能导致：
  - 网络请求超时
  - 数据库连接耗尽
  - 被目标网站限流
- 错误重试建议使用并发数 1，稳定性优先

---

## 🐛 常见问题

### Q1: 抓取时出现大量超时怎么办？

**原因**: 并发数过高或网络不稳定

**解决方法**:
```bash
# 降低并发数到 1
export SYNC_CONCURRENCY=1
npm run sync:date 2025-01-01 2025-01-01
```

### Q2: 错误日志文件找不到怎么办？

**原因**: 错误日志保存在 `error-logs` 文件夹中

**解决方法**:
```bash
# 查看所有错误日志（在项目根目录）
ls error-logs/

# 直接使用文件名即可（推荐）
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-03.json

# 或使用相对路径
npm run sync:retry ../error-logs/sync-errors-2025-01-01-to-2025-01-31-2025-11-03.json
```

### Q3: 数据库连接失败怎么办？

**原因**: DATABASE_URL 配置错误或数据库服务不可用

**解决方法**:
1. 检查 `.env` 文件中的 `DATABASE_URL` 是否正确
2. 确认数据库服务正常运行
3. 查看数据库连接日志

### Q4: 如何查看详细的错误信息？

**方法**:
```bash
# 设置 DEBUG 环境变量
export DEBUG=1
npm run sync:date 2025-01-01 2025-01-01
```

### Q5: 可以同时运行多个抓取任务吗？

**不推荐**: 可能导致数据库连接冲突或资源竞争

**建议**: 等待一个任务完成后再运行下一个

### Q6: 重试多次后仍有失败记录怎么办？

**可能原因**:
1. 目标研报页面确实存在问题
2. 网络持续不稳定
3. 被目标网站限流

**处理方法**:
1. 查看错误日志中的具体错误信息
2. 手动访问对应的研报链接确认是否可访问
3. 如果是个别记录，可以选择暂时忽略
4. 等待一段时间（几小时或第二天）后再次重试

---

## 📝 快速参考

### 常用命令速查表

```bash
# 正常抓取单日数据
npm run sync:date 2025-01-01 2025-01-01

# 正常抓取范围数据
npm run sync:date 2025-01-01 2025-01-31

# 重试失败记录（直接使用文件名）
npm run sync:retry sync-errors-2025-01-01-to-2025-01-31-2025-11-03.json

# 设置并发数后抓取
export SYNC_CONCURRENCY=1
npm run sync:date 2025-01-01 2025-01-01

# 查看所有错误日志
ls error-logs/
```

### 文件路径速查

- **脚本位置**: `backend/scripts/`
  - 正常抓取: `sync-custom-range.ts`
  - 错误重试: `sync-retry-errors.ts`
- **错误日志**: `error-logs/` 文件夹（项目根目录下）
- **环境配置**: `backend/.env`
- **数据库配置**: `prisma/schema.prisma`

---

## 📞 获取帮助

如果遇到本文档未涵盖的问题：

1. 查看项目文档：`docs/` 目录下的其他文档
2. 查看抓取机制详解：`docs/sync-mechanism.md`
3. 查看快速开始指南：`docs/quick-start-sync.md`
4. 提交 Issue 或联系维护人员

---

**最后更新**: 2025-11-04
**文档版本**: v1.1

**更新日志:**
- v1.1 (2025-11-04): 错误日志统一存放到 `error-logs` 文件夹
- v1.0 (2025-11-03): 初始版本
