# å¼€å‘è¿›åº¦è®°å½•

## å½“å‰è¿›åº¦
- æœ¬åœ°å‰åç«¯å¯æŒ‰ç…§ docs/local-dev.md æ–‡æ¡£è”è°ƒï¼ŒReact å‰ç«¯åœ¨ VITE_API_BASE_URL=http://localhost:4000/api ä¸‹èƒ½å¤ŸæˆåŠŸè·å–ç ”æŠ¥åˆ—è¡¨ä¸åˆ†ç±»æ•°æ®ã€‚
- Prisma å®¢æˆ·ç«¯åœ¨æ„å»ºé˜¶æ®µä¼šç”Ÿæˆ Linux (debian-openssl-3.0.x) ä¸æœ¬æœºäºŒè¿›åˆ¶ï¼Œackend/scripts/postbuild.mjs ä¼šå°†è¿è¡Œæ—¶å¤åˆ¶åˆ° ackend/dist/node_modulesï¼Œä¿è¯ Vercel Serverless å¯ç›´æ¥åŠ è½½ã€‚
- Vercel Functions ä¸­çš„ pi/reports.tsã€pi/categories.ts ç­‰æ–‡ä»¶æ˜ç¡®æ³¨å†Œäº†è·¯å¾„ï¼Œå¹¶æ‰“å°è¯·æ±‚å…¥å‚ã€å“åº”ç»“æŸæ—¥å¿—ï¼Œæ–¹ä¾¿çº¿ä¸Šæ’æŸ¥ã€‚

## å·²å¤„ç†çš„éš¾ç‚¹
- **CORS**ï¼šæœ¬åœ°è”è°ƒæç¤º Failed to fetchï¼Œé€šè¿‡åœ¨ ackend/server.ts ä¸­å¢åŠ  pp.use("/api/*", cors()) å¤„ç†è·¨åŸŸã€‚
- **Prisma è¿æ¥**ï¼šçº¿ä¸Šåˆå§‹åŒ–æ›¾é˜»å¡ï¼Œç§»é™¤ channel_binding=require å‚æ•°å¹¶æ˜¾å¼è°ƒç”¨ $connect()ï¼ŒåŒæ—¶è¾“å‡ºæˆåŠŸ/å¤±è´¥æ—¥å¿—ã€‚
- **Prisma äºŒè¿›åˆ¶ç¼ºå¤±**ï¼šWindows ç”Ÿæˆçš„åŒ…ç¼ºå°‘ Linux æŸ¥è¯¢å¼•æ“ï¼Œå·²åœ¨ schema.prisma è®¾ç½® inaryTargets = ["native", "debian-openssl-3.0.x"] å¹¶åœ¨æ‰“åŒ…é˜¶æ®µå¤åˆ¶ .prisma ç›®å½•ã€‚
- **Hono è·¯ç”±æœªå‘½ä¸­**ï¼šæ—©æœŸæœªæ˜¾å¼æŒ‡å®šè·¯å¾„å¯¼è‡´è¯·æ±‚æŒ‚èµ·ï¼Œç°å·²åœ¨å„å‡½æ•°ä¸­æ³¨å†Œ /ã€/reportsã€/categories ç­‰è·¯å¾„å¹¶æ‰“å° c.req.pathã€‚

## Timeout æ’æŸ¥è®°å½•
1. **æ—¥å¿—åŠ å›º**ï¼š
   - åœ¨ Prisma åˆå§‹åŒ–ã€æ•°æ®åº“æŸ¥è¯¢ã€API å“åº”é˜¶æ®µåŠ å…¥è¯¦ç»†æ—¥å¿—ï¼Œç¡®è®¤æ‰§è¡Œæµç¨‹ã€‚
2. **æ„å»ºä¼˜åŒ–**ï¼š
   - npm run vercel-build æŒ‰ prisma generate -> backend build -> frontend build é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿éƒ¨ç½²åŒ…åŒ…å« Linux å¼•æ“ã€‚
3. **è·¯ç”±è°ƒæ•´**ï¼š
   - å»é™¤å…œåº• pp.all("*")ï¼Œåªä¿ç•™å®é™…è·¯å¾„ï¼Œé¿å…è¯·æ±‚æ‚¬æŒ‚ï¼›åŒæ—¶æ‰“å°å®é™… path ä»¥ç¡®è®¤å‘½ä¸­ã€‚
4. **å“åº”ç¡®è®¤**ï¼š
   - åœ¨ API è¿”å›å‰è¾“å‡º "å“åº”ç»“æŸ" æ—¥å¿—ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦åœ¨ 300 ç§’å†…å®Œæˆå“åº”ã€‚

## å¾…åŠäº‹é¡¹
- **ç»§ç»­å®šä½ 504**ï¼šå½“å‰æ—¥å¿—æ˜¾ç¤ºæŸ¥è¯¢ä¸å“åº”å‡æˆåŠŸå®Œæˆï¼Œä½† Vercel ä»æŠ¥å‘Šè¶…æ—¶ï¼Œéœ€ç»§ç»­è§‚å¯Ÿæ˜¯å¦å­˜åœ¨å“åº”æµæœªå…³é—­æˆ–å¤§æ•°æ®ä¼ è¾“é—®é¢˜ï¼Œå¯è€ƒè™‘ Response Streaming æˆ–æå‰ç»“æŸå“åº”ã€‚
- **ç¼“å­˜ä¸åå°ä»»åŠ¡**ï¼šæ ¹æ®çº¿ä¸Šè€—æ—¶æƒ…å†µï¼Œè®¡åˆ’å¼•å…¥ Redis/Vercel KV ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œæˆ–å°†è€—æ—¶åŒæ­¥æ”¹ä¸ºåå°ä»»åŠ¡ï¼Œé¿å…å ç”¨å‰å°è¯·æ±‚ 5 åˆ†é’Ÿæ—¶é™ã€‚
- **éƒ¨ç½²å¤æ ¸**ï¼šå¾… Vercel æ–°éƒ¨ç½²å®Œæˆåæ”¶é›†å¸¦"å“åº”ç»“æŸ"æ—¥å¿—çš„å®Œæ•´è¾“å‡ºï¼Œç»§ç»­è§‚å¯Ÿæ˜¯å¦ä»è§¦å‘ 300 ç§’è¶…æ—¶ï¼Œå¹¶è®°å½•åç»­ä¼˜åŒ–æ–¹æ¡ˆã€‚

> è¯´æ˜ï¼šåç»­è‹¥å¢åŠ ç¼“å­˜/åå°ä»»åŠ¡æˆ–å…¶ä»–ä¼˜åŒ–ï¼Œéœ€è¦åœ¨æœ¬è®°å½•æ›´æ–°é˜¶æ®µæ€§ç»“æœï¼Œæ–¹ä¾¿è¿½è¸ªã€‚

## è¿½åŠ åˆ†æï¼ˆ2025-10-30ï¼‰
- æœ€æ–°ä¸€ç‰ˆéƒ¨ç½²çš„ Vercel Function æ—¥å¿—æ˜¾ç¤ºï¼ŒlistReports æŸ¥è¯¢ä¸ API å“åº”åœ¨å‡ ç™¾æ¯«ç§’å†…å®Œæˆï¼Œå¹¶è¾“å‡º "å“åº”ç»“æŸ"ï¼Œä½†å‡½æ•°ä»åœ¨ 5 åˆ†é’Ÿåè¶…æ—¶ï¼Œè¯´æ˜ä¸»é€»è¾‘å·²ç»“æŸä½†ä»æœ‰å°¾éƒ¨å¼‚æ­¥ä»»åŠ¡æœªé‡Šæ”¾ã€‚
- åˆæ­¥å®šä½ä¸º ackend/lib/prisma.ts ä¸­çš„é»˜è®¤è¡Œä¸ºï¼šåˆ›å»ºå®¢æˆ·ç«¯æ—¶ç«‹å³æ‰§è¡Œ client.()ï¼ˆå¹¶æŒ‚ä¸€ä¸ª Promiseï¼‰ï¼Œä»¥åŠæ³¨å†Œçš„ process.on('beforeExit', ...) é’©å­ä¼šåœ¨ Lambda é€€å‡ºå‰å†æ¬¡æ‰§è¡Œå¼‚æ­¥ $disconnect()ã€‚è¿™äº›åå° Promise å³ä¾¿åœ¨å“åº”è¿”å›åä»ç„¶è¿è¡Œï¼Œå¯¼è‡´äº‹ä»¶å¾ªç¯ä¸ä¸ºç©ºï¼Œä»è€Œè§¦å‘ 300 ç§’è¶…æ—¶ã€‚
- ä¸‹ä¸€æ­¥è®¡åˆ’ï¼šç§»é™¤ createPrismaClient() ä¸­çš„å³æ—¶ $connect() ä¸ eforeExit é’©å­ï¼Œä»…ä¾èµ–å„ä¸ª service å‡½æ•°ä¸­ inally çš„æ–­è¿é€»è¾‘ï¼›å®Œæˆåé‡æ–°éƒ¨ç½²éªŒè¯æ˜¯å¦è¿˜æœ‰è¶…æ—¶ã€‚

## æ•°æ®æŠ“å–æ—¥æœŸå¤„ç†ä¿®å¤ï¼ˆ2025-10-30ï¼‰

### é—®é¢˜å‘ç°
- ç”¨æˆ·åæ˜ å‘å¸ƒæ—¥æœŸï¼ˆ`report.date`ï¼‰å­—æ®µå­˜å‚¨é”™è¯¯ï¼Œæ˜¾ç¤ºä¸º `2025-10-27T16:00:00.000Z` è€Œé `2025-10-27T00:00:00.000Z`
- æ ¹æœ¬åŸå› ï¼šJavaScript çš„ `new Date("2025-10-27")` ä¼šæŒ‰ UTC è§£æï¼Œä½†æœ¬åœ°æ—¶åŒºä¸º UTC+8 ä¼šå¯¼è‡´æ—¶åŒºåç§»
- å½±å“èŒƒå›´ï¼š409 æ¡å†å²æ•°æ®å…¨éƒ¨é”™è¯¯ï¼Œæ–°æŠ“å–æ•°æ®ä»ä½¿ç”¨æ—§é€»è¾‘ç»§ç»­å‡ºé”™

### ä¿®å¤æ–¹æ¡ˆ
åœ¨ `backend/scripts/sync-runner.ts` ä¸­ä¼˜åŒ– `ensureDate()` å‡½æ•°ï¼Œä½¿ç”¨ `Date.UTC()` ç¡®ä¿æ—¥æœŸå§‹ç»ˆä¸º UTC åˆå¤œ

---

## æ•°æ®æŠ“å–è„šæœ¬ç¨³å®šæ€§æ”¹è¿›ï¼ˆ2025-11-03ï¼‰

### é—®é¢˜èƒŒæ™¯
- ç”¨æˆ·åœ¨æ‰§è¡Œå…¨æœˆæ•°æ®åŒæ­¥æ—¶ï¼Œè„šæœ¬åœ¨å¤„ç†è¡Œä¸šç ”æŠ¥æ—¶çªç„¶æŒ‚èµ·ï¼Œæ— æ³•ç»§ç»­å¤„ç†åç»­åˆ†ç±»
- æ— æ³•åˆ¤æ–­æ˜¯ç½‘ç»œé—®é¢˜ã€æ•°æ®åº“è¿æ¥é—®é¢˜è¿˜æ˜¯ç‰¹å®šè®°å½•å¯¼è‡´çš„å¡é¡¿
- é”™è¯¯æ²¡æœ‰è¯¦ç»†æ—¥å¿—è®°å½•ï¼Œæ’æŸ¥å›°éš¾

### è§£å†³æ–¹æ¡ˆ

#### 1. **è®°å½•çº§è¶…æ—¶æœºåˆ¶**ï¼ˆ60ç§’ï¼‰
- ä¸ºæ¯æ¡è®°å½•è®¾ç½® 60 ç§’è¶…æ—¶ï¼Œä½¿ç”¨ `Promise.race()` å®ç°
- è¶…æ—¶çš„è®°å½•è¢«æ ‡è®°ä¸ºé”™è¯¯å¹¶è·³è¿‡ï¼Œä¸ä¼šé˜»å¡åç»­å¤„ç†
- å³ä½¿æŸæ¡æŠ¥å‘Šçš„è¯¦æƒ…é¡µçˆ¬å–æˆ–æ•°æ®åº“å†™å…¥ç‰¹åˆ«æ…¢ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ•´ä¸ªè„šæœ¬æŒ‚èµ·

#### 2. **æ•°æ®åº“è¿æ¥é‡è¯•æœºåˆ¶**
- åœ¨ `backend/lib/prisma.ts` ä¸­æ·»åŠ  `withRetry()` å‡½æ•°
- è‡ªåŠ¨æ£€æµ‹ `Can't reach database server`ã€`ECONNREFUSED`ã€`ETIMEDOUT` ç­‰è¿æ¥é”™è¯¯
- ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ1s â†’ 1.5s â†’ 2.25sï¼‰è¿›è¡Œ 1-3 æ¬¡è‡ªåŠ¨é‡è¯•
- ä¸´æ—¶ç½‘ç»œæŠ–åŠ¨è‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€äººå·¥å¹²é¢„

#### 3. **å…³é”®æ•°æ®åº“æ“ä½œåŒ…è£…**
```typescript
// findMany() - 3 æ¬¡é‡è¯•
const existingRecords = await withRetry(
  () => prisma.report.findMany({ ... }),
  3,
  1000,
);

// create/update - 2 æ¬¡é‡è¯•
await withRetry(
  () => prisma.report.update({ ... }),
  2,
  500,
);
```

### æµ‹è¯•ç»“æœ

**5 æ—¥èŒƒå›´æµ‹è¯•ï¼ˆ2025-01-01 è‡³ 2025-01-05ï¼‰ï¼š**
- æ€»è€—æ—¶ï¼š309 ç§’
- æ€»è®°å½•æ•°ï¼š432 æ¡
- æˆåŠŸç‡ï¼š100%ï¼ˆæ— ä»»ä½•è¶…æ—¶é”™è¯¯ï¼‰

**å®Œæ•´æœˆä»½æµ‹è¯•ï¼ˆ2025-01-01 è‡³ 2025-01-31ï¼‰ï¼š**
- æ€»è€—æ—¶ï¼š4070 ç§’ï¼ˆ~68 åˆ†é’Ÿï¼‰
- æ€»è®°å½•æ•°ï¼š3,163 æ¡
- æˆåŠŸç‡ï¼š98.8%ï¼ˆ3,125 æˆåŠŸï¼Œ38 è¶…æ—¶ï¼‰

**åˆ†ç±»æ˜ç»†ï¼š**
| åˆ†ç±» | è·å– | æ–°å¢ | æ›´æ–° | è¶…æ—¶ | æˆåŠŸç‡ |
|------|------|------|------|------|--------|
| ç­–ç•¥ç ”æŠ¥ | 397 | 0 | 392 | 5 | 98.7% |
| å®è§‚ç ”æŠ¥ | 362 | 312 | 44 | 6 | 98.3% |
| è¡Œä¸šç ”æŠ¥ | 1815 | 1495 | 300 | 20 | 98.9% |
| ä¸ªè‚¡ç ”æŠ¥ | 589 | 515 | 67 | 7 | 98.8% |

### æ”¹è¿›å‰åå¯¹æ¯”
- **æ”¹è¿›å‰**ï¼šè¡Œä¸šç ”æŠ¥å¤„ç†åˆ° 250/1815 æ¡æ—¶è„šæœ¬æŒ‚èµ·ï¼Œæ— æ³•ç»§ç»­
- **æ”¹è¿›å**ï¼šæ‰€æœ‰ 1815 æ¡è¡Œä¸šç ”æŠ¥å…¨éƒ¨å¤„ç†å®Œæˆï¼Œ99% æˆåŠŸç‡

### å¯ç”¨åœºæ™¯
âœ… æ‰‹åŠ¨æ‰§è¡Œå…¨æœˆåŒæ­¥ï¼ˆæ— éœ€æ‹…å¿ƒå¡ä½ï¼‰
âœ… GitHub Actions è‡ªåŠ¨è¿è¡Œï¼ˆä¸´æ—¶æ•…éšœè‡ªåŠ¨æ¢å¤ï¼‰
âœ… Vercel Serverless éƒ¨ç½²ï¼ˆçŸ­æš‚ä¸­æ–­è‡ªåŠ¨é‡è¯•ï¼‰
âœ… å¤§è§„æ¨¡æ•°æ®å¤„ç†ï¼ˆ1800+ è®°å½•ä»èƒ½å®Œæˆï¼‰
âœ… ä¸ç¨³å®šç½‘ç»œç¯å¢ƒï¼ˆè‡ªåŠ¨é‡è¯•æé«˜æˆåŠŸç‡ï¼‰

### æäº¤ä¿¡æ¯
- Commit: 7409aa8
- Message: `feat(sync): add database connection retry mechanism and per-record timeout`

---

## æ•°æ®æŠ“å–æ—¥æœŸå¤„ç†ä¿®å¤ï¼ˆ2025-10-30ï¼‰

### é—®é¢˜å‘ç°
- ç”¨æˆ·åæ˜ å‘å¸ƒæ—¥æœŸï¼ˆ`report.date`ï¼‰å­—æ®µå­˜å‚¨é”™è¯¯ï¼Œæ˜¾ç¤ºä¸º `2025-10-27T16:00:00.000Z` è€Œé `2025-10-27T00:00:00.000Z`
- æ ¹æœ¬åŸå› ï¼šJavaScript çš„ `new Date("2025-10-27")` ä¼šæŒ‰ UTC è§£æï¼Œä½†æœ¬åœ°æ—¶åŒºä¸º UTC+8 ä¼šå¯¼è‡´æ—¶åŒºåç§»
- å½±å“èŒƒå›´ï¼š409 æ¡å†å²æ•°æ®å…¨éƒ¨é”™è¯¯ï¼Œæ–°æŠ“å–æ•°æ®ä»ä½¿ç”¨æ—§é€»è¾‘ç»§ç»­å‡ºé”™

### ä¿®å¤æ–¹æ¡ˆ
åœ¨ `backend/scripts/sync-runner.ts` ä¸­ä¼˜åŒ– `ensureDate()` å‡½æ•°ï¼Œä½¿ç”¨ `Date.UTC()` ç¡®ä¿æ—¥æœŸå§‹ç»ˆä¸º UTC åˆå¤œï¼š

```typescript
const ensureDate = (value: unknown) => {
  const raw = value as string | undefined;
  if (!raw) return new Date();

  // API è¿”å›æ ¼å¼ï¼š2025-10-30 00:00:00.000
  // æå– YYYY-MM-DD éƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´
  const match = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    const [, yearStr, monthStr, dayStr] = match;
    // åˆ›å»ºå½“å¤©çš„ UTC åˆå¤œæ—¶é—´ï¼Œé¿å…æ—¶åŒºåç§»
    return new Date(Date.UTC(Number(yearStr), Number(monthStr) - 1, Number(dayStr), 0, 0, 0, 0));
  }

  const date = new Date(raw);
  return Number.isNaN(date.getTime()) ? new Date() : date;
};
```

### æ‰§è¡Œæ­¥éª¤
1. æ¸…ç©ºæ•°æ®åº“ä¸­çš„ 268 æ¡æ—§æ•°æ®
2. è¿è¡Œä¼˜åŒ–åçš„è„šæœ¬æŠ“å–æ–°æ•°æ®ï¼ˆ`SYNC_LOOKBACK_DAYS=2`ï¼‰
3. éªŒè¯æ–°æ•°æ®æ—¥æœŸæ ¼å¼

### éªŒè¯ç»“æœ
âœ… **æµ‹è¯•é€šè¿‡**ï¼ˆ2025-10-30 13:00 UTCï¼‰
- æŠ“å– 268 æ¡æ–°æŠ¥å‘Šï¼Œæ—¥æœŸèŒƒå›´ 2025-10-28 ~ 2025-10-30
- å…¨éƒ¨æŠ¥å‘Šçš„ `date` å­—æ®µæ ¼å¼æ­£ç¡®ï¼š`2025-10-30T00:00:00.000Z`ï¼ˆUTC åˆå¤œï¼‰
- `createdAt` å­—æ®µä¿æŒç²¾ç¡®æ—¶é—´æˆ³ï¼š`2025-10-30T12:44:32.669Z`
- æ— ä»»ä½•æ—¶åŒºåç§»é”™è¯¯

### GitHub Actions è‡ªåŠ¨åŒ–
- âœ… å·²ç¡®è®¤æ¯å¤© UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00) è‡ªåŠ¨è¿è¡Œ
- âœ… ç¯å¢ƒå˜é‡ï¼š`SYNC_LOOKBACK_DAYS=2`ã€`SYNC_CONCURRENCY=8`
- âœ… åç»­æ¯æ—¥è‡ªåŠ¨æŠ“å–æœ€è¿‘ 2 å¤©æ•°æ®ï¼Œä½¿ç”¨æ­£ç¡®çš„æ—¥æœŸå¤„ç†é€»è¾‘
\n## PDF Á´½Ó¶µµ×ĞŞ¸´£¨2025-11-17£©\n### ÎÊÌâ±³¾°\n- ²ßÂÔ/ºê¹ÛÏêÇéÒ³ÈÔ¿ÉÒÔ½âÎöµ½ `zwinfo.attach_url`£¬µ«ĞĞÒµ/¹«Ë¾ÏêÇéÒ³½üÆÚÒÆ³ıÁË¸Ã×Ö¶Î£¬`pdfUrl` ´óÁ¿Îª `null`£¨Í³¼Æ½öÔ¼ 2% ĞĞÒµ±¨¸æÓĞ PDF£©£¬Ç°¶Ë¿¨Æ¬µã»÷Ìø×ªÌåÑéÊÜÓ°Ïì¡£\n\n### ½â¾ö·½°¸\n- ÔÚ backend/scripts/detail-parser.ts ÖĞĞÂÔö `normalizeInfoCode`¡¢`buildPdfUrlFromInfoCode`£¬Í¨¹ı `infoCode` Ö±½ÓÆ´½Ó `https://pdf.dfcfw.com/pdf/H3_${infoCode}_1.pdf` ×÷Îª¶µµ×¡£\n- `fetchDetailInfo` ÔÚ½âÎöÏêÇéÒ³Ç°¾ÍÉú³É `fallbackPdfUrl`£¬¼´Ê¹ÇëÇóÊ§°Ü»ò `zwinfo` È±Ê§Ò²ÄÜ·µ»ØÓĞĞ§ PDF£»`resolveDetailUrl` Í¬²½Ê¹ÓÃ `normalizeInfoCode`£¬±ÜÃâ infoCode Ç°ºó¿Õ°×µ¼ÖÂÆ´½ÓÊ§°Ü¡£\n\n### ÑéÖ¤·½Ê½\n- ÔËĞĞ `npx tsx detail-inspect.ts industry 3`£¨Óë CLI ÈÕÖ¾ÏàÍ¬£©£¬¿ÉÒÔ¿´µ½×îĞÂĞĞÒµ±¨¸æµÄ `pdfUrl` ÒÑ±äÎª `https://pdf.dfcfw.com/pdf/H3_..._1.pdf`¡£\n- ½¨Òé°Ñ `.env` ÖĞ `SYNC_SKIP_EXISTING=false`£¬Ö´ĞĞÒ»´Î `bun run backend/scripts/sync-runner.ts` »ò `sync:date` »ØÌîÀúÊ·Êı¾İ£¬ÔÙ»Ö¸´Ä¬ÈÏÅäÖÃÒÔ±£³ÖÔöÁ¿Í¬²½¡£
