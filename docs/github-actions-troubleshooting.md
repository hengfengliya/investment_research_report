# GitHub Actions æ•°æ®åº“è¿æ¥æ•…éšœæ’æŸ¥æŒ‡å—

## é—®é¢˜ç°è±¡

å½“ GitHub Actions è¿è¡Œæ•°æ®åŒæ­¥ä»»åŠ¡æ—¶ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```
Can't reach database server at ep-steep-unit-adwx68g1-pooler.c-2.us-east-1.aws.neon.tech:5432
```

---

## å¿«é€Ÿè¯Šæ–­æ¸…å•

### âœ… ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ GitHub ç¯å¢ƒå˜é‡é…ç½®

**æ“ä½œè·¯å¾„ï¼š**
1. è®¿é—® GitHub ä»“åº“é¡µé¢ï¼š`https://github.com/[ä½ çš„ç”¨æˆ·å]/investment-research-report`
2. ç‚¹å‡» **Settings**ï¼ˆè®¾ç½®ï¼‰
3. å·¦ä¾§é€‰æ‹© **Secrets and variables** â†’ **Actions**

**éœ€è¦é…ç½®çš„å˜é‡ï¼š**

#### é€‰é¡¹ Aï¼šä½¿ç”¨ Repository Secretsï¼ˆæ¨èï¼‰
åœ¨ **Secrets** é€‰é¡¹å¡ä¸­æ·»åŠ ï¼š

| åç§° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `DATABASE_URL` | `postgresql://ç”¨æˆ·å:å¯†ç @ä¸»æœºåœ°å€/æ•°æ®åº“å?sslmode=require` | ä»æœ¬åœ° `.env` æ–‡ä»¶å¤åˆ¶ï¼Œ**ç§»é™¤** `channel_binding=require` å‚æ•° |

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```
postgresql://neondb_owner:npg_xxxxx@ep-steep-unit-adwx68g1-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require
```

**é”™è¯¯ç¤ºä¾‹ï¼ˆåŒ…å« channel_bindingï¼‰ï¼š**
```
postgresql://...?sslmode=require&channel_binding=require  âŒ
```

#### é€‰é¡¹ Bï¼šä½¿ç”¨ Repository Variables
åœ¨ **Variables** é€‰é¡¹å¡ä¸­æ·»åŠ ï¼ˆå¦‚æœä¸æƒ³åŠ å¯†ï¼‰ï¼š

| åç§° | å€¼ |
|------|-----|
| `DATABASE_URL` | åŒä¸Š |

**æ³¨æ„ï¼š** ç”±äºåŒ…å«å¯†ç ï¼Œå»ºè®®ä½¿ç”¨ Secrets è€Œé Variablesã€‚

---

### âœ… ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ Environment é…ç½®

ç”±äºä½ çš„ workflow ä½¿ç”¨äº† `environment: production`ï¼Œéœ€è¦é¢å¤–é…ç½®ç¯å¢ƒå˜é‡ï¼š

1. åœ¨ä»“åº“ Settings é¡µé¢ï¼Œå·¦ä¾§é€‰æ‹© **Environments**
2. ç‚¹å‡» **production** ç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºï¼‰
3. åœ¨ **Environment secrets** ä¸­æ·»åŠ  `DATABASE_URL`

---

### âœ… ç¬¬ä¸‰æ­¥ï¼šå”¤é†’ Neon æ•°æ®åº“

Neon å…è´¹ç‰ˆæ•°æ®åº“ä¼šåœ¨é—²ç½®åè‡ªåŠ¨ä¼‘çœ ï¼Œé¦–æ¬¡è¿æ¥éœ€è¦ 5-10 ç§’å”¤é†’æ—¶é—´ã€‚

**æ‰‹åŠ¨å”¤é†’æ–¹æ³•ï¼š**

#### æ–¹æ³• 1ï¼šé€šè¿‡ Neon æ§åˆ¶å°
1. è®¿é—® https://console.neon.tech/
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. ç‚¹å‡»æ•°æ®åº“ï¼ŒæŸ¥çœ‹çŠ¶æ€
4. å¦‚æœæ˜¾ç¤º "Idle"ï¼Œç‚¹å‡»ä»»æ„æŸ¥è¯¢æŒ‰é’®å”¤é†’

#### æ–¹æ³• 2ï¼šæœ¬åœ°æµ‹è¯•è¿æ¥ï¼ˆæ¨èï¼‰
è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•å¹¶å”¤é†’æ•°æ®åº“ï¼š

```powershell
cd C:\Users\18805\Desktop\word\CC\investment-research-report\backend
npm run test:db
```

å¦‚æœæœ¬åœ°èƒ½è¿æ¥æˆåŠŸï¼Œè¯´æ˜æ•°æ®åº“æ­£å¸¸ï¼Œé—®é¢˜åœ¨äº GitHub Actions é…ç½®ã€‚

---

### âœ… ç¬¬å››æ­¥ï¼šéªŒè¯è¿æ¥å­—ç¬¦ä¸²æ ¼å¼

ç¡®ä¿ `DATABASE_URL` æ ¼å¼æ­£ç¡®ï¼š

```
postgresql://ç”¨æˆ·å:å¯†ç @ä¸»æœº:ç«¯å£/æ•°æ®åº“?å‚æ•°1=å€¼1&å‚æ•°2=å€¼2
```

**å¿…é¡»ç§»é™¤çš„å‚æ•°ï¼š**
- `channel_binding=require` âŒ ï¼ˆä¼šå¯¼è‡´æŸäº›ç¯å¢ƒè¿æ¥å¤±è´¥ï¼‰

**æ¨èä¿ç•™çš„å‚æ•°ï¼š**
- `sslmode=require` âœ…
- `connect_timeout=30` âœ… ï¼ˆå·²ç”±ä»£ç è‡ªåŠ¨æ·»åŠ ï¼‰
- `pool_timeout=30` âœ… ï¼ˆå·²ç”±ä»£ç è‡ªåŠ¨æ·»åŠ ï¼‰

---

### âœ… ç¬¬äº”æ­¥ï¼šæµ‹è¯• GitHub Actions è¿æ¥

#### æ‰‹åŠ¨è§¦å‘ Workflow
1. è¿›å…¥ä»“åº“çš„ **Actions** æ ‡ç­¾
2. é€‰æ‹© "Daily Sync Research Reports" workflow
3. ç‚¹å‡» **Run workflow** æŒ‰é’®
4. é€‰æ‹©åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ `main`ï¼‰
5. ç‚¹å‡»ç»¿è‰²çš„ **Run workflow** æŒ‰é’®

#### æŸ¥çœ‹è¿è¡Œæ—¥å¿—
1. ç‚¹å‡»åˆšåˆšè§¦å‘çš„è¿è¡Œè®°å½•
2. å±•å¼€ **Test database connection** æ­¥éª¤
3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**æˆåŠŸç¤ºä¾‹ï¼š**
```
==========================================================
æ•°æ®åº“è¿æ¥æµ‹è¯•å¼€å§‹
==========================================================

ğŸ“¡ ç›®æ ‡æ•°æ®åº“: postgresql://neondb_owner:***@ep-steep-unit-adwx68g1-pooler.c-2.us-east-1.aws.neon.tech/neondb

â³ å°è¯•è¿æ¥æ•°æ®åº“...
âœ… è¿æ¥æˆåŠŸï¼è€—æ—¶ 2345ms
ğŸ“… æ•°æ®åº“æ—¶é—´: 2025-01-06T10:30:45.123Z

â³ æµ‹è¯•æŸ¥è¯¢ Report è¡¨...
âœ… Report è¡¨åŒ…å« 3163 æ¡è®°å½•
ğŸ“° æœ€æ–°ç ”æŠ¥: xxxxç ”ç©¶æŠ¥å‘Š (industry, 2025-01-05)

==========================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®åº“è¿æ¥æ­£å¸¸
==========================================================
```

**å¤±è´¥ç¤ºä¾‹åŠè¯Šæ–­ï¼š**
```
âŒ æ•°æ®åº“è¿æ¥å¤±è´¥
é”™è¯¯ä¿¡æ¯: Can't reach database server

ğŸ’¡ å¯èƒ½åŸå› :
  1. Neon æ•°æ®åº“å¤„äºä¼‘çœ çŠ¶æ€ï¼ˆå…è´¹ç‰ˆä¼šè‡ªåŠ¨ä¼‘çœ ï¼‰
  2. ç½‘ç»œè¿æ¥é—®é¢˜ï¼ˆé˜²ç«å¢™/DNSï¼‰
  3. æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²é”™è¯¯

ğŸ”§ è§£å†³æ–¹æ¡ˆ:
  - è®¿é—® Neon æ§åˆ¶å°æ‰‹åŠ¨å”¤é†’æ•°æ®åº“
  - æ£€æŸ¥ DATABASE_URL æ˜¯å¦æ­£ç¡®
  - ç¡®ä¿ç§»é™¤äº† channel_binding=require å‚æ•°
```

---

## å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1: `DATABASE_URL environment variable is not set`

**åŸå› ï¼š** GitHub Secrets/Variables ä¸­æœªé…ç½® `DATABASE_URL`

**è§£å†³ï¼š** æŒ‰ç…§"ç¬¬ä¸€æ­¥"å’Œ"ç¬¬äºŒæ­¥"é…ç½®ç¯å¢ƒå˜é‡

---

### é”™è¯¯ 2: `Can't reach database server`

**å¯èƒ½åŸå› ï¼š**
1. âœ… æ•°æ®åº“å¤„äºä¼‘çœ çŠ¶æ€ï¼ˆæœ€å¸¸è§ï¼‰
2. âŒ è¿æ¥å­—ç¬¦ä¸²åŒ…å« `channel_binding=require`
3. âŒ GitHub Actions IP è¢«é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ–¹æ¡ˆ 1ï¼šç­‰å¾…æ•°æ®åº“å”¤é†’ï¼ˆå·²ä¼˜åŒ–ï¼‰
æ–°ç‰ˆæœ¬ä»£ç å·²é…ç½®ï¼š
- è¿æ¥è¶…æ—¶ï¼š30 ç§’ï¼ˆè¶³å¤Ÿå†·å¯åŠ¨æ—¶é—´ï¼‰
- è‡ªåŠ¨é‡è¯•ï¼šæœ€å¤š 5 æ¬¡ï¼Œé—´éš”é€’å¢ï¼ˆ2s â†’ 3s â†’ 4.5s ...ï¼‰

å¦‚æœä»ç„¶å¤±è´¥ï¼Œå¯èƒ½æ˜¯ï¼š

#### æ–¹æ¡ˆ 2ï¼šæ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²
ç¡®ä¿ `DATABASE_URL` ä¸­**æ²¡æœ‰** `channel_binding=require` å‚æ•°ã€‚

æœ¬åœ° `.env` æ–‡ä»¶ä¸­çš„è¿æ¥å­—ç¬¦ä¸²å¯ä»¥ä¿ç•™æ­¤å‚æ•°ï¼ˆä»£ç ä¼šè‡ªåŠ¨ç§»é™¤ï¼‰ï¼Œä½† GitHub Secrets ä¸­å»ºè®®ç›´æ¥ç§»é™¤ã€‚

#### æ–¹æ¡ˆ 3ï¼šæ£€æŸ¥ Neon æ•°æ®åº“è®¾ç½®
è®¿é—® Neon æ§åˆ¶å°ï¼Œç¡®ä¿ï¼š
- æ•°æ®åº“é¡¹ç›®çŠ¶æ€æ­£å¸¸ï¼ˆéæš‚åœï¼‰
- è¿æ¥é™åˆ¶æœªè¾¾åˆ°ä¸Šé™ï¼ˆå…è´¹ç‰ˆé€šå¸¸é™åˆ¶ 100 ä¸ªå¹¶å‘è¿æ¥ï¼‰

---

### é”™è¯¯ 3: `Authentication failed`

**åŸå› ï¼š** ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯

**è§£å†³ï¼š**
1. è®¿é—® Neon æ§åˆ¶å° â†’ é¡¹ç›® â†’ Connection Details
2. å¤åˆ¶å®Œæ•´çš„è¿æ¥å­—ç¬¦ä¸²
3. ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦
4. é‡æ–°é…ç½® GitHub Secrets

---

## ä¼˜åŒ–æ¸…å•ï¼ˆå·²å®Œæˆï¼‰

ä»¥ä¸‹ä¼˜åŒ–å·²åœ¨ä»£ç ä¸­å®ç°ï¼š

- âœ… **è‡ªåŠ¨ç§»é™¤ `channel_binding=require` å‚æ•°**ï¼ˆ`backend/lib/prisma.ts:42`ï¼‰
- âœ… **è‡ªåŠ¨æ·»åŠ  `connect_timeout=30` å’Œ `pool_timeout=30`**ï¼ˆ`backend/lib/prisma.ts:48-54`ï¼‰
- âœ… **è¿æ¥é‡è¯•æœºåˆ¶**ï¼ˆæœ€å¤š 5 æ¬¡ï¼Œé—´éš”é€’å¢ï¼‰
- âœ… **è¯¦ç»†çš„é”™è¯¯æ—¥å¿—**ï¼ˆåŒ…å«è¯Šæ–­å»ºè®®ï¼‰
- âœ… **GitHub Actions é¢„è¿æ¥æµ‹è¯•**ï¼ˆè¿è¡ŒåŒæ­¥å‰å…ˆæµ‹è¯•è¿æ¥ï¼‰

---

## æœ¬åœ°æµ‹è¯•å‘½ä»¤

### æµ‹è¯•æ•°æ®åº“è¿æ¥
```powershell
cd C:\Users\18805\Desktop\word\CC\investment-research-report\backend
npm run test:db
```

### è¿è¡Œæ—¥å¸¸åŒæ­¥ï¼ˆæŠ“å–æœ€è¿‘ 2 å¤©ï¼‰
```powershell
npm run sync
```

### è¿è¡Œè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´åŒæ­¥
```powershell
npm run sync:date 2025-01-01 2025-01-31
```

---

## éœ€è¦æŠ€æœ¯æ”¯æŒï¼Ÿ

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥éª¤ä»æ— æ³•è§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **GitHub Actions è¿è¡Œæ—¥å¿—**ï¼ˆå®Œæ•´çš„ "Test database connection" æ­¥éª¤è¾“å‡ºï¼‰
2. **Neon æ•°æ®åº“çŠ¶æ€æˆªå›¾**
3. **æœ¬åœ°æµ‹è¯•ç»“æœ**ï¼ˆ`npm run test:db` è¾“å‡ºï¼‰
4. **DATABASE_URL æ ¼å¼**ï¼ˆéšè—å¯†ç éƒ¨åˆ†ï¼‰

ç¤ºä¾‹ï¼š
```
postgresql://neondb_owner:***@ep-steep-unit-adwx68g1-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require
```
